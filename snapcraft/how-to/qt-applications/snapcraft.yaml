name: kcalc
adopt-info: kcalc
license: GPL-2.0-or-later
base: core22
grade: stable
confinement: strict

apps:
  kcalc:
    common-id: org.kde.kcalc.desktop
    command: usr/bin/kcalc
    extensions: [kde-neon]
    plugs:
      - audio-playback

slots:
  session-dbus-interface:
    interface: dbus
    name: org.kde.kcalc.desktop
    bus: session

layout:
  /usr/share/applications/org.kde.kcalc.desktop:
    symlink: $SNAP/usr/share/applications/org.kde.kcalc.desktop
  /usr/share/sounds/Oxygen-Sys-App-Message.ogg:
    symlink: $SNAP/kf5/usr/share/sounds/freedesktop/stereo/dialog-information.oga
  /usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libcanberra-0.30/libcanberra-pulse.so:
    symlink: $SNAP/usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libcanberra-0.30/libcanberra-pulse.so

parts:
  libcanberra:
    plugin: nil
    override-pull: |
      if [ ! -e libcanberra-pulse_*.deb ]; then apt-get download libcanberra-pulse:$CRAFT_ARCH_BUILD_FOR; fi
    override-build: |
      if [ ! -e $CRAFT_PART_INSTALL/usr/lib/$CRAFT_ARCH_TRIPLET_BUILD_FOR/libcanberra-*/libcanberra-pulse.so>
        dpkg -x $CRAFT_PART_SRC/libcanberra-pulse_*.deb $CRAFT_PART_INSTALL
      fi
  kcalc:
    after: [kde-neon/sdk]
    parse-info: [usr/share/metainfo/org.kde.kcalc.appdata.xml]
    plugin: cmake
    build-packages:
      - libgmp-dev
      - libmpfr-dev
    stage-packages:
      - libgmp10
      - libmpfr6
    source: https://invent.kde.org/utilities/kcalc/-/archive/v23.08.5/kcalc-v23.08.5.tar.gz
    cmake-parameters:
      - "-DCMAKE_BUILD_TYPE=Release"
      - "-DCMAKE_INSTALL_PREFIX=/usr"
      - "-DKDE_INSTALL_USE_QT_SYS_PATHS=ON"
      - "-DKDE_SKIP_TEST_SETTINGS=ON"
      - "-DINSTALL_ICONS=ON"
    override-build: |
      if [ ! -e /usr/share/xml ]; then
        ln -s /snap/kf5-*-core22-sdk/current/usr/share/xml/ /usr/share/xml
      fi
      craftctl default
    override-prime: |
      craftctl default
      FILE=snap/command-chain/desktop-launch
      if [ -e $CRAFT_PRIME/$FILE ]; then rm $CRAFT_PRIME/$FILE; fi
      CMD='busctl call --user org.freedesktop.portal.Desktop /org/freedesktop/portal/desktop '\
      'org.freedesktop.portal.Settings Read ss org.gnome.desktop.interface'
      sed /wait_for_async_execs/i\
      "export XCURSOR_THEME=\$($CMD cursor-theme | cut -d \\\\\" -f2)\n"\
      "export XCURSOR_SIZE=\$($CMD cursor-size | cut -d' ' -f4)\n" $CRAFT_STAGE/$FILE > $CRAFT_PRIME/$FILE
      chmod +x $CRAFT_PRIME/$FILE
